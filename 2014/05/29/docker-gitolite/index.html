<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>BetaCZ.com - Gitolite on Docker</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="BetaCZ.com - 慢半拍" />
    <meta name="author" content="Beta CZ" />
    <meta charset="UTF-8" />
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="shortcut icon" type="image/png" href="/favicon.gif"/>
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Roboto+Slab' rel='stylesheet' type='text/css'>
      <link href="/stylesheets/bootstrap.min.css" rel="stylesheet" />
      <link href="/stylesheets/syntax-dark.css" rel="stylesheet" />
      <link href="/stylesheets/main.css" rel="stylesheet"/>
       <link href="/stylesheets/googlesearch_fix.css" rel="stylesheet"/>
      <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-48462264-2', 'betacz.com');
      ga('send', 'pageview');
      </script>
    </head>
    <body>
      <nav class="navbar navbar-inverse" role="navigation">
        <div class='container'>
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <a class="navbar-brand" href="/">Beta CZ 的烂笔头</a>
          </div>
          <!-- Collect the nav links, forms, and other content for toggling -->
          <ul class="nav navbar-nav ">
            <li><a href="/about.html">关于我</a></li>
            <li><a href="/cats_and_tags.html#categories">分类</a></li>
            <li><a href="/cats_and_tags.html#tags">标签</a></li>
            <li><a href="/series">专题</a></li>
            <li><a href="/archives.html">归档</a></li>
          </ul>
          <form class="navbar-form navbar-right navbar-search" role="search">
            <div class="form-group">
              <input type="text" class="form-control search-query" placeholder="搜索">
            </div>
            <button type="submit" class="nav-search "><span class="glyphicon glyphicon-search"></span></button>
          </form>
          <ul class="nav navbar-nav  hidden-sm">
            <li><a href="/atom.xml" title='订阅' target="_blank"><i class="icon-rss"></i></a></li>
          </ul>
        </div>
      </nav>
      <div class='container'>
        <div class="row">
	<div class="col-lg-12" id="content">
		<article class="page">
	<div class="page-header">
		<h2 class="entry-title"><a href="/2014/05/29/docker-gitolite/">Gitolite on Docker</a>
			<small>
				<span class="entry-date">2014-05-29</span>
			</small>
		</h2>
	</div>

	<div class="article-body">
		<div class="row">
			<div class="col-lg-12">
				<div class="article-body">
					<p>在公司内部我们有十多个项目用Git作为源代码版本控制工具。因为是内部项目，所以简单在一台内网Linux服务器上创建一个名为git的用户，所有项目成员都通过此用户，使用ssh协议来读写中心代码库。同时，又用nginx架设了一个HTTP服务器，在部署环境提供Git仓库的只读访问。</p>

<p>但是这样做的弊端也很明显，尤其在以下几点方面让人比较头疼：</p>

<ul>
<li>项目成员有变化时，需要管理员登录到服务器上去手工增加或删除ssh公钥。</li>
<li>因为所有成员都通过git用户来访问，一旦为某个成员在服务器上增加了公钥，就意味着同时开放了这台服务器所有其它项目的代码。</li>
<li>只能通过HTTP或SSH协议来提供只读/读写两类权限控制，无法对项目内容进行细粒度的权限控制。</li>
<li>为一个项目开放HTTP访问需要管理员手工去修改hook。</li>
</ul>

<p>总之，这种SSH方式虽然简单易行，但在安全性和便利性上却不尽如人意。</p>

<p>Gitolite作为更强大但也更复杂的Git服务器，以前也看到很多人在推荐。但因为需求没那么迫切，一直没有好好研究过。不过最近在做应用的Docker化时，产生了把Git服务器也打包成一个Docker容器的想法。既然要动手，那就干脆直接迁移到Gitolite上吧。</p>

<h2>构建容器</h2>

<hr>

<p>此容器的构建代码可以从我的<a href="https://github.com/hlj/gitolite-docker">Github项目</a>上下载。</p>

<p>项目中包括4个文件，其中唯一需要修改就是<code>admin.pub</code>文件。这个文件的内容应该是您自己使用ssh-keygen产生的公钥文件。您可以直接替换这个文件的内容，也可以完全删除这个文件并用自己的文件代替。如果您不想使用<code>admin.pub</code>这个名称，也可以改成任意名称，但一定要同步修改<code>Dockerfile</code>里的相关内容。</p>

<p>在修改好这个文件后，就可以直接运行构建命令了：</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>docker build -t gitolite .
</code></pre></div>
<h2>使用</h2>

<hr>

<p><em>注意：这里仅介绍容器本身的使用，Gitolite的使用请自行参考<a href="https://github.com/sitaramc/gitolite#readme">相关手册</a></em></p>

<h3>准备</h3>

<p>在使用这个容器之前，首先要在主机准备一个空目录，用以存储Git仓库的内容。在脚本中默认是使用<code>/opt/git</code>。</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>sudo mkdir -p /opt/git
<span class="nv">$ </span>sudo chown <span class="nv">$USER</span>:<span class="nv">$USER</span> /opt/git
</code></pre></div>
<p>记住一定要把这个目录的读写权限赋给运行容器的用户。</p>

<p>您也可以选择别的目录，但需要同步修改<code>gitolite</code>这个脚本中的相关部分。</p>

<h3>运行</h3>

<p>运行这个容器也很简单,直接用项目中自带的<code>gitolite</code>这个脚本就可以了：</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">./gitolite start
</code></pre></div>
<p>这个脚本是基于我写的<a href="http://betacz.com/2014/05/29/docker-app-script-template/">Docker应用管理脚本模板</a>制作的，如有需要，也可自行修改。</p>

<h3>测试</h3>

<p>现在，Gitolite服务已经顺利跑起来了，可以测试一下:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">git clone ssh://git@localhost:22222/testing
</code></pre></div>
<p>如果在这一步发生错误，那可能是您改动了<code>gitolite</code>脚本的相关配置，请仔细检查一下。</p>

<h3>额外配置rc文件</h3>

<p>这个Gitolite服务器使用的是默认配置。如果您想自定义一此选项，只需要修改<code>/opt/git/gitolite.rc</code>这个配置文件即可。 这个文件是在首次启动服务器时，从容器内的<code>~/.gitolite.rc</code>文件复制出来的（见<code>start.sh</code>）。</p>

<p>在修改这个文件后，需要重启一下容器才能生效:</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="nv">$ </span>./gitolite stop <span class="o">&amp;&amp;</span> ./gitolite start
</code></pre></div>
<h3>容器被删除了?</h3>

<p>如果容器被删除了（使用<code>docker rm</code>或<code>./gitolite remove</code>)，那么可以用<code>./gitolite start</code>重新启动。但启动完成后，必须要重新推送一下<code>gitolite-admin</code>这个仓库。如下所示：</p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh">~/gitolite-admin<span class="nv">$ </span>git push -f
</code></pre></div>
<p>在您把Gitolite迁移到其它主机上时，也需要如此操作。</p>

				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-lg-5 col-lg-offset-7">
				
				<div class="post-details">
	分类:
		
			
				<a href="/category/服务器 开发工具"><span class="label label-default">服务器 开发工具</span></a>
			
		
	|
	标签:
		
			
				<a href="/tag/Docker"><span class="label label-default">Docker</span></a>
			
				<a href="/tag/Git"><span class="label label-default">Git</span></a>
			
		
	|
	<a href="http://betacz.com/2014/05/29/docker-gitolite/"><span class="label label-info">Permalink</span></a>
</div>



			</div>
		</div>
		<div class="row">
			<div class="col-lg-12">
				 <div id="disqus_thread"></div>
			    <script type="text/javascript">
			        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
			        var disqus_shortname = 'betacz-blog'; // required: replace example with your forum shortname

			        /* * * DON'T EDIT BELOW THIS LINE * * */
			        (function() {
			            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			        })();
			    </script>
			    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</div>
	</div>
</article>

	</div>
</div>

      </div>
      <footer class="rjfooter">
        <div class="container">
          <div class="row">
            <div class="col-lg-6 col-lg-offset-3">
              <p>&copy 2014.04 - Beta CZ ::: Hosted by <a href="https://pages.github.com/">GitHub Pages</a></p>
              <p class="disclaimer">
              <small>
              <strong>免责声明:</strong> 此站为个人站点，本站内容除特别注明外均为本人原创。文章内容仅代表个人观点，
              与本人所属公司或组织无关。其他组织或个人也无权主张本站所有内容的版权。
              </small>
              </p>
            </div>
          </div>
        </div>
      </footer>
      <script type="text/javascript" src="/js/jquery-2.0.3.min.js"></script>
      <script type="text/javascript" src="/js/bootstrap.min.js"></script>
      <script type="text/javascript">
      $('.search-query').keypress(function (e) {
        if (e.which == 13) {
          $(this).closest('form').submit();
          return false;  
        }
      });
      $('.navbar-search').on('submit', function(){
        var url =  '/search.html?q=' + $('.search-query').val();
        window.location.href=url;
        return false;
      })
      </script>
    </body>
  </html>